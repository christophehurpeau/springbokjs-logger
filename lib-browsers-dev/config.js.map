{"version":3,"sources":["../src/config.js"],"names":["configure","addConfig","Config","pattern","RegExp","key","keys","handler","handlers","processor","processors","global","__NIGHTINGALE_GLOBAL_HANDLERS","console","log","process","exit","__NIGHTINGALE_CONFIG","__NIGHTINGALE_LOGGER_MAP_CACHE","Map","__NIGHTINGALE_CONFIG_DEFAULT","clearCache","clear","handleConfig","config","Error","patterns","length","map","unshift","configIsForKey","includes","test","__NIGHTINGALE_GET_CONFIG_FOR_LOGGER","getConfigForLogger","globalCache","has","get","loggerConfig","filter","some","push","stop","set","__NIGHTINGALE_GET_CONFIG_FOR_LOGGER_RECORD","getConfigForLoggerRecord","level","minLevel","isHandling"],"mappings":"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","file":"config.js","sourcesContent":["import findLevel from 'nightingale-debug';\n\ntype Config = {\n  pattern: ?RegExp,\n  key: ?string,\n  keys: ?Array<string>,\n  handler: ?Object,\n  handlers: ?Array<Object>,\n  processor: ?any,\n  processors: ?Array<any>,\n};\n\nif (global.__NIGHTINGALE_GLOBAL_HANDLERS) {\n  // eslint-disable-next-line no-console\n  console.log('nightingale: update all to ^5.0.0');\n  process.exit(1);\n}\n\nif (!global.__NIGHTINGALE_CONFIG) {\n  global.__NIGHTINGALE_CONFIG = [];\n  global.__NIGHTINGALE_LOGGER_MAP_CACHE = new Map();\n  global.__NIGHTINGALE_CONFIG_DEFAULT = { handlers: [], processors: [] };\n}\n\nfunction clearCache() {\n  global.__NIGHTINGALE_LOGGER_MAP_CACHE.clear();\n}\n\nfunction handleConfig(config: Config) {\n  if (config.keys) {\n    if (config.pattern) {\n      throw new Error('Cannot have key and pattern for the same config');\n    }\n    if (config.key) {\n      throw new Error('Cannot have key and keys for the same config');\n    }\n  } else if (config.key) {\n    if (config.pattern) {\n      throw new Error('Cannot have key and pattern for the same config');\n    }\n    config.keys = [config.key];\n    delete config.key;\n  }\n\n  if (config.patterns) {\n    throw new Error('config.patterns is no longer supported, use pattern');\n  }\n\n  if (config.handler) {\n    if (config.handlers) {\n      throw new Error('Cannot have handler and handlers for the same config');\n    }\n    config.handlers = [config.handler];\n    delete config.handler;\n  }\n\n  if (config.processor) {\n    if (config.processors) {\n      throw new Error('Cannot have processors and processors for the same config');\n    }\n    config.processors = [config.processor];\n    delete config.processor;\n  }\n\n  return config;\n}\n\nexport function configure(config) {\n  if (global.__NIGHTINGALE_CONFIG.length !== 0) {\n    // eslint-disable-next-line no-console\n    console.log('nightingale: warning: config overridden');\n  }\n\n  clearCache();\n  global.__NIGHTINGALE_CONFIG = config.map(handleConfig);\n}\n\nexport function addConfig(config: Config, unshift = false) {\n  config = handleConfig(config);\n  global.__NIGHTINGALE_CONFIG[unshift ? 'unshift' : 'push'](config);\n  clearCache();\n}\n\nconst configIsForKey = key => config => {\n  if (config.keys) return config.keys.includes(key);\n  if (config.pattern) return config.pattern.test(key);\n  return true;\n};\n\nglobal.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER = function getConfigForLogger(key) {\n  const globalCache = global.__NIGHTINGALE_LOGGER_MAP_CACHE;\n\n  if (globalCache.has(key)) {\n    return globalCache.get(key);\n  }\n\n  const loggerConfig = {\n    handlers: [],\n    processors: [],\n  };\n\n  global.__NIGHTINGALE_CONFIG.filter(configIsForKey(key)).some((config) => {\n    if (config.handlers) loggerConfig.handlers.push(...config.handlers);\n    if (config.processors) loggerConfig.processors.push(...config.processors);\n    return config.stop;\n  });\n\n  globalCache.set(key, loggerConfig);\n  return loggerConfig;\n};\n\nglobal.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER_RECORD = function getConfigForLoggerRecord(key, level) {\n  const { handlers, processors } = global.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER(key);\n\n  return {\n    handlers: handlers.filter(handler => (\n      level >= findLevel(handler.minLevel, key) && (\n        !handler.isHandling || handler.isHandling(level, key)\n      )\n    )),\n    processors,\n  };\n};\n\n"]}