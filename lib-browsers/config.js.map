{"version":3,"sources":["../src/config.js"],"names":["configure","addConfig","addGlobalProcessor","addGlobalHandler","global","__NIGHTINGALE_CONFIG","__NIGHTINGALE_GLOBAL_PROCESSORS","__NIGHTINGALE_GLOBAL_HANDLERS","__NIGHTINGALE_LOGGER_MAP_CACHE","Map","__NIGHTINGALE_CONFIG_DEFAULT","handlers","processors","clearCache","clear","handleConfig","config","key","patterns","Error","pattern","handler","minimatchPatterns","map","length","console","log","reverse","forEach","push","unshift","processor","__NIGHTINGALE_GET_CONFIG_FOR_LOGGER","globalProcessors","globalHandlers","globalCache","has","get","value","find","c","some","p","match","loggerConfig","concat","set"],"mappings":"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","file":"config.js","sourcesContent":["import { Minimatch } from 'minimatch';\n\ntype Config = {\n  pattern: ?string,\n  patterns: ?Array<string>,\n  handler: ?Object,\n  handlers: ?Array<Object>,\n}\n\nif (!global.__NIGHTINGALE_CONFIG) {\n  global.__NIGHTINGALE_CONFIG = [];\n  global.__NIGHTINGALE_GLOBAL_PROCESSORS = [];\n  global.__NIGHTINGALE_GLOBAL_HANDLERS = [];\n  global.__NIGHTINGALE_LOGGER_MAP_CACHE = new Map();\n  global.__NIGHTINGALE_CONFIG_DEFAULT = {\n    handlers: [],\n    processors: [],\n  };\n}\n\nfunction clearCache() {\n  global.__NIGHTINGALE_LOGGER_MAP_CACHE.clear();\n}\n\nfunction handleConfig(config: Config) {\n  if (config.key) {\n    if (config.patterns) {\n      throw new Error('Cannot have key and patterns for the same config');\n    }\n    config.patterns = [config.key];\n    delete config.key;\n  }\n\n  if (config.pattern) {\n    if (config.patterns) {\n      throw new Error('Cannot have pattern and patterns for the same config');\n    }\n    config.patterns = [config.pattern];\n    delete config.pattern;\n  }\n\n  if (config.handler) {\n    if (config.handlers) {\n      throw new Error('Cannot have handler and handlers for the same config');\n    }\n    config.handlers = [config.handler];\n    delete config.handler;\n  }\n\n  if (config.patterns) {\n    config.minimatchPatterns = config.patterns.map(pattern => new Minimatch(pattern));\n  }\n\n  return config;\n}\n\nexport function configure(config) {\n  if (global.__NIGHTINGALE_CONFIG.length !== 0) {\n        // eslint-disable-next-line no-console\n    console.log('nightingale: warning: config overridden');\n  }\n\n  clearCache();\n  global.__NIGHTINGALE_CONFIG = [];\n  global.__NIGHTINGALE_CONFIG_DEFAULT = null;\n\n  config.reverse().forEach(config => {\n    config = handleConfig(config);\n\n    if (config.patterns) {\n      global.__NIGHTINGALE_CONFIG.push(config);\n    } else {\n      if (global.__NIGHTINGALE_CONFIG_DEFAULT) {\n        throw new Error('Config cannot contains more than 1 default declaration');\n      }\n\n      global.__NIGHTINGALE_CONFIG_DEFAULT = config;\n    }\n  });\n\n  if (!global.__NIGHTINGALE_CONFIG_DEFAULT) {\n    global.__NIGHTINGALE_CONFIG_DEFAULT = {\n      handlers: [],\n      processors: [],\n    };\n  }\n}\n\nexport function addConfig(config: Config, unshift = true) {\n  config = handleConfig(config);\n\n  if (!config.patterns) {\n    throw new Error('Config must have `pattern` or `patterns`');\n  }\n\n  clearCache();\n  global.__NIGHTINGALE_CONFIG[unshift ? 'unshift' : 'push'](config);\n}\n\nexport function addGlobalProcessor(processor) {\n  clearCache();\n  global.__NIGHTINGALE_GLOBAL_PROCESSORS.push(processor);\n}\n\nexport function addGlobalHandler(handler) {\n  clearCache();\n  global.__NIGHTINGALE_GLOBAL_HANDLERS.push(handler);\n}\n\nglobal.__NIGHTINGALE_GET_CONFIG_FOR_LOGGER = function (key) {\n  const globalProcessors = global.__NIGHTINGALE_GLOBAL_PROCESSORS;\n  const globalHandlers = global.__NIGHTINGALE_GLOBAL_HANDLERS;\n  const globalCache = global.__NIGHTINGALE_LOGGER_MAP_CACHE;\n\n  if (globalCache.has(key)) {\n    return globalCache.get(key);\n  }\n\n  let value = global.__NIGHTINGALE_CONFIG.find(c => c.minimatchPatterns.some(p => p.match(key)));\n  if (!value) {\n    value = global.__NIGHTINGALE_CONFIG_DEFAULT;\n  }\n\n  let loggerConfig = {\n    patterns: value.patterns,\n    handlers: value.handlers ? globalHandlers.concat(value.handlers) : globalHandlers,\n    processors: value.processors ? globalProcessors.concat(value.processors) : globalProcessors,\n  };\n\n  globalCache.set(key, loggerConfig);\n  return loggerConfig;\n};\n"]}